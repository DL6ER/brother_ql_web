{% extends "base.html" %}

{% block app_content %}
<div class="row">
    <!-- Dark mode toggle button and settings buttons -->
    <div style="position: absolute; top: 10px; right: 20px; z-index: 1000; display: flex; gap: 10px; align-items: center;">
        <div id="darkModeToggle" style="cursor: pointer; font-size: 1.6em;">
            <span id="darkModeIcon" title="Toggle dark mode" style="transition: color 0.2s;"></span>
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="Settings">
            <button type="button" id="exportSettings" class="btn btn-secondary" title="Export settings"><span class="fas fa-download"></span> Export</button>
            <button type="button" id="importSettings" class="btn btn-secondary" title="Import settings"><span class="fas fa-upload"></span> Import</button>
            <button type="button" id="resetSettings" class="btn btn-danger" title="Reset settings"><span class="fas fa-undo"></span> Reset</button>
        </div>
    </div>
    <div class="col-md-4">
    <fieldset class="form-group">
            <div class="accordion" id="accordion" style="max-height: 90vh; overflow-y: auto;">

                <div class="card">
                    <div class="card-header" id="heading1">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="true" aria-controls="collapse1">
                            <span class="fas fa-file" aria-hidden="true"></span> Label Size
                        </button>
                        <span id="labelMismatchIcon" class="float-right text-danger" style="display: none;">
                            <span class="fas fa-exclamation-triangle" aria-hidden="true"></span>
                        </span>
                    </div>
                    <div id="collapse1" class="collapse" aria-labelledby="heading1" data-parent="#accordion">
                        <div class="card-body">
                            <label for="labelSize" style="margin-bottom: 0">Label Size:</label>
                            <select class="form-control" id="labelSize" onChange="preview()" data-default="{{default_label_size}}">
                                {% for label_size in label_sizes %}<option value="{{label_size[0]}}" data-x="{{label_size[3][0]}}"
                                    data-y="{{label_size[3][1]}}" data-round="{{label_size[2]}}" {% if default_label_size==label_size[0]
                                    %}selected{% endif %}>{{label_size[1]}}</option>{% endfor %}
                            </select>
                            <div class="form-text text-muted">Detected label: <span id="label-width">???</span> x <span id="label-height">???</span></div>
                            <div id="labelMismatch" class="form-text text-danger" style="display: none;">Label size mismatch detected!</div>

                            <label for="orientation" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Label Orientation:</label>
                            <div class="btn-group btn-group-toggle btn-block mb-2" data-toggle="buttons">
                                <label class="btn btn-secondary {% if default_orientation == 'standard' %}active{% endif %}" id="orientation_standard">
                                    <input type="radio" name="orientation" onchange="preview()" value="standard" aria-label="Standard" {% if
                                        default_orientation=='standard' %}checked data-default="1" {% endif %}>
                                    <span class="fas fa-ruler-horizontal" aria-hidden="true"> Standard
                                </label>
                                <label class="btn btn-secondary {% if default_orientation == 'rotated' %}active{% endif %}" id="orientation_rotated">
                                    <input type="radio" name="orientation" onchange="preview()" value="rotated" aria-label="Rotated" {% if
                                        default_orientation=='rotated' %}checked data-default="1" {% endif %}>
                                    <span class="fas fa-ruler-vertical" aria-hidden="true"> Rotated
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" onchange="preview()" id="highResolutionCheckbox" data-default="0">
                                <label class="form-check-label" for="highResolutionCheckbox">
                                    High-resolution printing (600 dpi)
                                </label>
                            </div>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading2">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="true" aria-controls="collapse2">
                            <span class="fas fa-font" aria-hidden="true"></span> Font Settings
                        </button>
                    </div>
                    <div id="collapse2" class="collapse show" aria-labelledby="heading2" data-parent="#accordion">
                        <div class="card-body">
                            <div id="fontSettingsLineSelector">
                                <label for="lineSelect" style="margin-bottom: 0">Select Line:</label>
                                <select class="form-control" id="lineSelect">
                                </select>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" data-default="1" id="syncFontSettings" checked>
                                <label class="form-check-label" for="syncFontSettings">
                                    Use same font for all lines
                                </label>
                            </div>

                            <div id="fontSettingsContainer">
                                <div id="fontSetting">
                                    <label for="fontFamily" style="margin-bottom: 0">Font Family:</label>
                                    <select class="form-control" id="fontFamily" onChange="updateStyles()">
                                        {% for font_family_name in font_family_names %}
                                            <option {% if default_font_family == font_family_name %}selected{% endif %}>{{font_family_name}}</option>
                                        {% endfor %}
                                    </select>

                                    <label for="fontStyle" style="margin-top: 10px; margin-bottom: 0">Font Style:</label>
                                    <select class="form-control" id="fontStyle" onChange="preview()">
                                    </select>

                                    <label for="fontSize" style="margin-top: 10px; margin-bottom: 0">Font Size:</label>
                                    <input id="fontSize" class="form-control" type="number" min="1" data-default="{{default_font_size}}" onChange="preview()" required>

                                    <label for="fontAlign" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Font Alignment:</label>
                                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                        <label class="btn btn-secondary ">
                                            <input type="radio" name="fontAlign" onchange="preview()" value="left" aria-label="Left Align"><span class="fas fa-align-left" aria-hidden="true"></span>
                                        </label>
                                        <label class="btn btn-secondary active">
                                            <input type="radio" name="fontAlign" onchange="preview()" value="center" aria-label="Center Align" checked><span class="fas fa-align-center" aria-hidden="true"></span>
                                        </label>
                                        <label class="btn btn-secondary">
                                            <input type="radio" name="fontAlign" onchange="preview()" value="right" aria-label="Right Align"><span class="fas fa-align-right" aria-hidden="true"></span>
                                        </label>
                                    </div>

                                    <label for="lineSpacing" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Line Spacing:</label>
                                    <div class="btn-group btn-group-toggle btn-block mb-3" data-toggle="buttons">
                                        {% for line_spacing in line_spacings %}
                                        <label class="btn btn-secondary {% if default_line_spacing == line_spacing %}active{% endif %}" id="lineSpacing{{line_spacing}}">
                                            <input type="radio" name="lineSpacing" onchange="preview()" value="{{line_spacing}}" aria-label="{{line_spacing}}%" {% if default_line_spacing == line_spacing %}checked{% endif %}>{{line_spacing}}%
                                        </label>
                                        {% endfor %}
                                    </div>
                                    <h6>Additional Font Options:</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" onchange="preview()" id="fontInverted" data-default="0">
                                        <label class="form-check-label" for="fontInverted">
                                            Invert text
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" onchange="preview()" id="fontCheckbox" data-default="0">
                                        <label class="form-check-label" for="fontCheckbox">
                                            TODO item (checkbox)
                                        </label>
                                    </div>
                                    <div class="red-support">
                                        <label for="printColor" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Print
                                            Color:</label>
                                        <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
                                            <label class="btn btn-dark" id="print_color_black">
                                                <input type="radio" name="fontColor" onchange="preview()" value="black" aria-label="Black" data-default="1">Black
                                            </label>
                                            <label class="btn btn-danger" id="print_color_red">
                                                <input type="radio" name="fontColor" onchange="preview()" value="red" aria-label="Red">Red
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading4">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse4" aria-expanded="true" aria-controls="collapse4">
                            <span class="fas fa-qrcode" aria-hidden="true"></span> Code Settings
                        </button>
                    </div>
                    <div id="collapse4" class="collapse" aria-labelledby="heading4" data-parent="#accordion">
                        <div class="card-body">
                            <label for="barcodeType" style="margin-bottom: 0">Barcode Type:</label>
                            <select class="form-control" id="barcodeType" onChange="preview()"></select>

                            <div id="qrCodeSizeContainer">
                                <label for="qrCodeSize" style="margin-top: 10px; margin-bottom: 0">QR Code Size:</label>
                                <input id="qrCodeSize" class="form-control" type="number" min="1" data-default="{{default_qr_size}}" onChange="preview()"
                                    required>
                            </div>

                            <div id="qrCodeCorrectionContainer">
                                <label for="qrCodeCorrection" style="margin-top: 10px; margin-bottom: 0">Error Correction:</label>
                                <select class="form-control" id="qrCodeCorrection" onChange="preview()">
                                    <option value="L">About 7% can be corrected.</option>
                                    <option value="M">About 15% can be corrected.</option>
                                    <option value="Q">About 25% can be corrected.</option>
                                <option value="H">About 30% can be corrected.</option>
                            </select>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading5">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse5" aria-expanded="true" aria-controls="collapse5">
                            <span class="fas fa-image" aria-hidden="true"></span> Image Settings
                        </button>
                    </div>
                    <div id="collapse5" class="collapse" aria-labelledby="heading5" data-parent="#accordion">
                        <div class="card-body">
                            <label for="imageMode" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Image mode:</label>

                            <label class="btn btn-secondary {% if default_image_mode == 'black_and_white' %}active{% endif %}" id="image_mode_bw">
                                <input type="radio" name="imageMode" onchange="preview()" value="black_and_white" aria-label="Black & White" {% if default_image_mode == 'black_and_white' %}checked{% endif %}>
                                <span class="fas fa-ruler-horizontal" aria-hidden="true"> Black & White
                            </label>
                            <label class="btn btn-secondary {% if default_image_mode == 'grayscale' %}active{% endif %}" id="image_mode_grayscale">
                                <input type="radio" name="imageMode" onchange="preview()" value="grayscale" aria-label="Grayscale" {% if default_image_mode == 'grayscale' %}checked{% endif %}>
                                <span class="fas fa-ruler-vertical" aria-hidden="true"> Grayscale
                            </label>
                            <div class="red-support">
                                <label class="btn btn-secondary {% if default_image_mode == 'colored' %}active{% endif %}" id="image_mode_colored">
                                    <input type="radio" name="imageMode" onchange="preview()" value="colored" aria-label="Colored" {% if default_image_mode == 'colored' %}checked{% endif %}>
                                    <span class="fas fa-ruler-horizontal" aria-hidden="true"> Colored
                                </label>
                                <label class="btn btn-secondary {% if default_image_mode == 'red_and_black' %}active{% endif %}" id="image_mode_red_and_black">
                                    <input type="radio" name="imageMode" onchange="preview()" value="red_and_black" aria-label="Red & Black" {% if default_image_mode == 'red_and_black' %}checked{% endif %}>
                                    <span class="fas fa-ruler-vertical" aria-hidden="true"> Red & Black
                                </label>
                            </div>

                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" value="1" onchange="preview()" id="imageFitCheckbox" checked>
                                <label class="form-check-label" for="imageFitCheckbox">
                                    Auto-fit image to label
                                </label>
                            </div>

                            <label for="imageBwThreshold" style="margin-top: 10px; margin-bottom: 0">Black & White threshold:</label>
                            <input id="imageBwThreshold" class="form-control" type="number" min="1" max="255" data-default="{{default_bw_threshold}}" onChange="preview()">
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading3">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse3" aria-expanded="true" aria-controls="collapse3">
                            <span class="fas fa-arrows-alt" aria-hidden="true"></span> Margins and Borders
                        </button>
                    </div>
                    <div id="collapse3" class="collapse" aria-labelledby="heading3" data-parent="#accordion">
                        <div class="card-body">
                            <label for="marginTop" style="margin-bottom: 0">Margin Top:</label>
                            <div class="input-group marginsTopBottom">
                                <input id="marginTop" class="form-control marginsTopBottom" type="number" min="0" max="200" data-default="{{default_margin_top}}" onChange="preview()" aria-describedby="marginTop-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginTop-addon">px</span>
                                </div>
                            </div>
                            <label for="marginBottom" style="margin-top: 10px; margin-bottom: 0">Margin Bottom:</label>
                            <div class="input-group marginsTopBottom">
                                <input id="marginBottom" class="form-control marginsTopBottom" type="number" min="0" max="200" data-default="{{default_margin_bottom}}" onChange="preview()" aria-describedby="marginBottom-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginBottom-addon">px</span>
                                </div>
                            </div>
                            <label for="marginLeft" style="margin-top: 10px; margin-bottom: 0">Margin Left:</label>
                            <div class="input-group marginsLeftRight">
                                <input id="marginLeft" class="form-control marginsLeftRight" type="number" min="0" max="200" data-default="{{default_margin_left}}" onChange="preview()" aria-describedby="marginLeft-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginLeft-addon">px</span>
                                </div>
                            </div>
                            <label for="marginRight" style="margin-top: 10px; margin-bottom: 0">Margin Right:</label>
                            <div class="input-group marginsLeftRight">
                                <input id="marginRight" class="form-control marginsLeftRight" type="number" min="0" max="200" data-default="{{default_margin_right}}" onChange="preview()" aria-describedby="marginRight-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginRight-addon">px</span>
                                </div>
                            </div>
                            <hr style="margin: 1.2em 0;" />
                            <label for="borderThickness" style="margin-bottom: 0">Border Thickness (0 = disabled):</label>
                            <input id="borderThickness" class="form-control mb-2" type="number" min="0" data-default="0" onChange="preview()" />
                            <label for="borderRoundness" style="margin-bottom: 0">Border Roundness:</label>
                            <input id="borderRoundness" class="form-control mb-2" type="number" min="0" data-default="0" onChange="preview()" />
                            <label for="borderDistanceX" style="margin-bottom: 0">Border Distance (left/right):</label>
                            <input id="borderDistanceX" class="form-control mb-2" type="number" min="0" data-default="0" onChange="preview()" />
                            <label for="borderDistanceY" style="margin-bottom: 0">Border Distance (top/bottom):</label>
                            <input id="borderDistanceY" class="form-control mb-2" type="number" min="0" data-default="0" onChange="preview()" />

                            <div class="red-support">
                                <label for="borderColor" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Print
                                    Color:</label>
                                <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
                                    <label class="btn btn-dark" id="border_color_black">
                                        <input type="radio" name="borderColor" onchange="preview()" value="black" aria-label="Black">Black
                                    </label>
                                    <label class="btn btn-danger" id="border_color_red">
                                        <input type="radio" name="borderColor" onchange="preview()" value="red" aria-label="Red">Red
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading6">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse6" aria-expanded="true" aria-controls="collapse6">
                            <span class="fas fa-wrench" aria-hidden="true"></span> Advanced Settings
                        </button>
                    </div>
                    <div id="collapse6" class="collapse" aria-labelledby="heading6" data-parent="#accordion">
                        <div class="card-body">
                            <label for="logLevel" style="margin-bottom: 0">Log Level:</label>
                            <select class="form-control mb-3" id="logLevel" onChange="preview()">
                                <option value="CRITICAL">CRITICAL</option>
                                <option value="ERROR">ERROR</option>
                                <option value="WARNING" selected>WARNING</option>
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                            </select>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="col-md-4">
        <label for="printType" class="control-label input-group" style="margin-bottom: 0">Print Type:</label>
        <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
            <label class="btn btn-secondary active" id="printTypeText">
                <input type="radio" name="printType" onchange="preview()" value="text" aria-label="Text" data-default="1" checked>
                <span class="fas fa-font" aria-hidden="true"></span><br>Text
            </label>
            <label class="btn btn-secondary" id="printTypeQrCode">
                <input type="radio" name="printType" onchange="preview()" value="qrcode" aria-label="Text">
                <span class="fas fa-qrcode" aria-hidden="true"></span><br>Code
            </label>
            <label class="btn btn-secondary" id="printTypeQrCodeText">
                <input type="radio" name="printType" onchange="preview()" value="qrcode_text" aria-label="QR Code + Text">
                <span class="fas fa-barcode" aria-hidden="true"></span> <span class="fas fa-font"
                    aria-hidden="true"></span><br>Code+Text
            </label>
            <label class="btn btn-secondary" id="printTypeImage">
                <input type="radio" name="printType" onchange="preview()" value="image" aria-label="Image">
                <span class="fas fa-image" aria-hidden="true"></span><br>Image
            </label>
        </div>

        <fieldset class="form-group" id="groupLabelImage">
            <label style="margin-top: 10px; margin-bottom: 0">Label Image:</label>
            <form class="dropzone" id="my-awesome-dropzone">
            </form>
        </fieldset>
        <fieldset class="form-group" id="groupLabelText">
            <label for="labelText" style="margin-top: 10px; margin-bottom: 0">Label Text:</label>
            <textarea rows="7" id="labelText" class="form-control" onChange="preview()" onInput="preview()" data-default=""></textarea>
            <!-- Template info box -->
            <div class="card mt-2" style="font-size: 0.95em;">
                <div class="card-header p-2" style="cursor: pointer; user-select: none;" data-toggle="collapse"
                    data-target="#templateInfoBox" aria-expanded="false" aria-controls="templateInfoBox">
                    <span class="fas fa-info-circle" aria-hidden="true"></span>
                    <span style="margin-left: 0.5em;">About label templates <span
                            class="fas fa-chevron-down float-right"></span></span>
                </div>
                <div id="templateInfoBox" class="collapse">
                    <div class="card-body pt-2 pb-2">
                        <strong>Templates</strong> allow you to insert dynamic content into your label text. Supported
                        templates:<br>
                        <ul style="margin-bottom: 0.5em;">
                            <li><code>{{'{{datetime:%H:%M:%S %d.%m.%Y'}}}}</code> — Inserts the current date and time when printing.
                                You can customize the format using <a href="https://strftime.org/" target="_blank"
                                    rel="noopener">strftime</a> options.</li>
                            <li><code>{{'{{counter'}}}}</code> — Inserts an up-counting number, increasing for every printed label.
                            </li>
                            <li><code>{{'{{uuid'}}}}</code> — Inserts a random UUID (Universally Unique Identifier).</li>
                            <li><code>{{'{{short-uuid'}}}}</code> — Inserts a shortened version of a UUID.</li>
                            <li><code>{{'{{env:var}}'}}</code> — Inserts the value of the environment variable <code>var</code>.
                            </li>
                        </ul>
                        <span class="text-muted">Templates are replaced at print time.</span>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="col-md-4">
    <fieldset class="form-group">
            <label for="previewImg" style="margin-bottom: 0">Label Preview:</label><br />
            <img id="previewImg" style="max-height: 350px; width: auto; max-width: 100%; display: block; margin-bottom: 1em;" />
            <p>Printed size: <span id="labelWidth">?</span> cm x <span id="labelHeight">?</span> cm</p>

            <div class="form-group">
                <label for="printCount" style="margin-top: 10px; margin-bottom: 0">Print Count:</label>
                <input id="printCount" class="form-control" type="number" min="1" max="100" data-default="1" required>
            </div>

            <div class="btn-group btn-block">
                <button type="button" id="printButton" class="btn btn-block btn-primary btn-lg" onClick="print()">
                    <span class="fas fa-print" aria-hidden="true"></span> Print
                </button>
                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" id="dropdownPrintButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-reference="parent">
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownPrintButton">
                    <a class="dropdown-item" href="#" onClick="print(true)">Cut only once</a>
                </div>
            </div>

        </fieldset>
        <div class="card">
            <div class="card-header">
                <span class="fas fa-terminal" aria-hidden="true" style="margin-right: 0.3em"></span> Status
                <span id="statusIcon" class="float-right fas fa-exclamation-triangle" aria-hidden="true"></span>
            </div>
            <div id="printerStatusPanel" class="card-body" style="display: none;">
                <div id="printerStatusBox" class="alert alert-secondary" role="alert"></div>
            </div>
            <div id="statusPanel" class="card-body">
                <div id="statusBox" class="alert alert-secondary" role="alert"><span>Idle...</span></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
const url_for_print = '{{ url_for('.print_label') }}';
const url_for_preview = '{{ url_for('.preview_from_image') }}';
const url_for_get_font_styles = '{{url_for('.get_font_styles')}}';
const url_for_get_barcodes = '{{ url_for('.get_barcodes') }}';
const url_for_get_printer_status = '{{ url_for('.get_printer_status') }}';
const default_dpi = {{ default_dpi }};

{{ super() }}
{% endblock %}
