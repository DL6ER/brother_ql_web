{% extends "base.jinja2" %}

{% block page_title %}
{{ title }}
{% endblock %}

{% block jumbotron %}
<h1>{{ website['PAGE_TITLE'] }}</h1>
<p>{{ website['PAGE_HEADLINE'] }}</p>
<!--<p><a class="btn btn-primary btn-lg" href="#" role="button">History of printed labels</a></p>-->
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <fieldset class="form-group">
            <div class="accordion" id="accordion">

                <div class="card">
                    <div class="card-header" id="heading1">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="true" aria-controls="collapse1">
                            <span class="fas fa-file" aria-hidden="true"></span> Label Size
                        </button>
                    </div>
                    <div id="collapse1" class="collapse" aria-labelledby="heading1" data-parent="#accordion">
                        <div class="card-body">
                            <label for="labelSize" style="display: none">Label Size:</label>
                            <select class="form-control" id="labelSize" onChange="preview()">
                                {% for label_size in label_sizes %}<option value="{{label_size[0]}}" data-round="{{label_size[2]}}" {% if label['DEFAULT_SIZE'] == label_size[0] %}selected{% endif %}>{{label_size[1]}}</option>{% endfor %}
                            </select>

                            <label for="orientation" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Label Orientation:</label>
                            <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
                                <label class="btn btn-secondary" id="orientation_standard">
                                    <input type="radio" name="orientation" onchange="preview()" value="standard" aria-label="Standard" {% if default_orientation == 'standard' %}checked{% endif %}>
                                    <span class="fas fa-ruler-horizontal" aria-hidden="true"> Standard
                                </label>
                                <label class="btn btn-secondary" id="orientation_rotated">
                                    <input type="radio" name="orientation" onchange="preview()" value="rotated" aria-label="Rotated" {% if default_orientation == 'rotated' %}checked{% endif %}>
                                    <span class="fas fa-ruler-vertical" aria-hidden="true"> Rotated
                                </label>
                            </div>

                            <label for="printColor" class="control-label input-group" style="margin-top: 10px; margin-bottom: 0">Print Color:</label>
                            <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
                                <label class="btn btn-dark" id="print_color_black">
                                    <input type="radio" name="printColor" onchange="preview()" value="black" aria-label="Black">Black
                                </label>
                                <label class="btn btn-danger" id="print_color_red">
                                    <input type="radio" name="printColor" onchange="preview()" value="red" aria-label="Red">Red
                                </label>
                            </div>

                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading2">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="true" aria-controls="collapse2">
                            <span class="fas fa-font" aria-hidden="true"></span> Font Settings
                        </button>
                    </div>
                    <div id="collapse2" class="collapse show" aria-labelledby="heading2" data-parent="#accordion">
                        <div class="card-body">
                            <label for="fontFamily">Font Family:</label>
                            <select class="form-control" id="fontFamily" onChange="preview()">
                                {% for font_family_name in font_family_names %}
                                    {% for font_style in fonts[font_family_name].keys() %}
                                        <option {% if label['DEFAULT_FONTS']['style'] == font_style and label['DEFAULT_FONTS']['family'] == font_family_name %}selected{% endif %}>{{font_family_name}} ({{ font_style }})</option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                            <label for="fontSize">Font Size:</label>
                            <input id="fontSize" class="form-control" type="number" min="1" value="{{ label['DEFAULT_FONT_SIZE'] }}" onChange="preview()" required>

                            <label for="fontAlign" class="control-label input-group">Font Alignment:</label>
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-secondary ">
                                    <input type="radio" name="fontAlign" onchange="preview()" value="left" aria-label="Left Align"><span class="fas fa-align-left" aria-hidden="true"></span>
                                </label>
                                <label class="btn btn-secondary active">
                                    <input type="radio" name="fontAlign" onchange="preview()" value="center" aria-label="Center Align" checked=""><span class="fas fa-align-center" aria-hidden="true"></span>
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="fontAlign" onchange="preview()" value="right" aria-label="Right Align"><span class="fas fa-align-right" aria-hidden="true"></span>
                                </label>
                            </div>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading4">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse4" aria-expanded="true" aria-controls="collapse4">
                            <span class="fas fa-qrcode" aria-hidden="true"></span> QR Code Settings
                        </button>
                    </div>
                    <div id="collapse4" class="collapse" aria-labelledby="heading4" data-parent="#accordion">
                        <div class="card-body">
                            <label for="fontSize">QR Code Size:</label>
                            <input id="qrCodeSize" class="form-control" type="number" min="1" value="{{default_qr_size}}" onChange="preview()" required>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="heading3">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse3" aria-expanded="true" aria-controls="collapse3">
                            <span class="fas fa-cog" aria-hidden="true"></span> Detailed Settings
                        </button>
                    </div>
                    <div id="collapse3" class="collapse" aria-labelledby="heading3" data-parent="#accordion">
                        <div class="card-body">
                            <label for="printType">Print Type:</label>
                            <select class="form-control" id="printType" onChange="preview()">
                                <option value="text">Text</option>
                                <option value="qrcode">QR Code</option>
                                <option value="qrcode_text">QR Code + Text</option>
                            </select>
                            <label for="marginTop">Margin Top:</label>
                            <div class="input-group marginsTopBottom">
                                <input id="marginTop" class="form-control" type="number" min="0" max="200" value="24" onChange="preview()" aria-describedby="marginTop-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginTop-addon">%</span>
                                </div>
                            </div>
                            <label for="marginBottom">Margin Bottom:</label>
                            <div class="input-group marginsTopBottom">
                                <input id="marginBottom" class="form-control" type="number" min="0" max="200" value="45" onChange="preview()" aria-describedby="marginBottom-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginBottom-addon">%</span>
                                </div>
                            </div>
                            <label for="marginLeft">Margin Left:</label>
                            <div class="input-group marginsLeftRight">
                                <input id="marginLeft" class="form-control" type="number" min="0" max="200" value="35" onChange="preview()" aria-describedby="marginLeft-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginLeft-addon">%</span>
                                </div>
                            </div>
                            <label for="marginRight">Margin Right:</label>
                            <div class="input-group marginsLeftRight">
                                <input id="marginRight" class="form-control" type="number" min="0" max="200" value="35" onChange="preview()" aria-describedby="marginRight-addon" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" id="marginRight-addon">%</span>
                                </div>
                            </div>
                        </div>
                        <!-- class="card-body" -->
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="col-md-4">
        <fieldset class="form-group">
            <label for="labelText">Label Text:</label>
            <textarea rows="7" id="labelText" class="form-control" onChange="preview()" onInput="preview()"></textarea>
        </fieldset>
    </div>
    <div class="col-md-4">
        <fieldset class="form-group">
            <label for="previewImg">Label Preview:</label><br />
            <img id="previewImg" style="border: 1px solid #ced4da; max-height: 350px; width: auto; max-width: 100%; margin-bottom: 10px;" />
            <p>Printed size w/o margins: <span id="labelWidth">?</span> cm x <span id="labelHeight">?</span> cm</p>

            <div class="form-group">
                <label for="printCount">Print Count:</label>
                <input id="printCount" class="form-control" type="number" min="1" max="100" value="1" required>
            </div>

            <div class="btn-group btn-block">
                <button type="button" id="printButton" class="btn btn-block btn-primary btn-lg" onClick="print()">
                    <span class="fas fa-print" aria-hidden="true"></span> Print
                </button>
                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" id="dropdownMenuReference" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-reference="parent">
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuReference">
                    <a class="dropdown-item" href="#" onClick="print(true)">Cut only once</a>
                </div>
            </div>

        </fieldset>
        <div class="card">
            <div class="card-header">
                <span class="fas fa-terminal" aria-hidden="true" style="margin-right: 0.3em"></span> Status
            </div>
            <div id="statusPanel" class="card-body">
                - Idle -
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
function formData(cut_once) {
    var text = $('#labelText').val();
    if (text == '') text = ' ';
    return {
        text:        text,
        font_family: $('#fontFamily option:selected').text(),
        font_size:   $('#fontSize').val(),
        label_size:  $('#labelSize option:selected').val(),
        align:       $('input[name=fontAlign]:checked').val(),
        orientation: $('input[name=orientation]:checked').val(),
        margin_top:    $('#marginTop').val(),
        margin_bottom: $('#marginBottom').val(),
        margin_left:   $('#marginLeft').val(),
        margin_right:  $('#marginRight').val(),
        print_type:    $('#printType').val(),
        qrcode_size:   $('#qrCodeSize').val(),
        print_count:   $('#printCount').val(),
        print_color:   $('input[name=printColor]:checked').val(),
        cut_once:      cut_once ? 1 : 0,
    }
}

function preview() {
    if ($('#labelSize option:selected').data('round') == 'True') {
        $('img#previewImg').addClass('roundPreviewImage');
    } else {
        $('img#previewImg').removeClass('roundPreviewImage');
    }

    if ($('input[name=orientation]:checked').val() == 'standard') {
        $('.marginsTopBottom').prop('disabled', false).removeAttr('title');
        $('.marginsLeftRight').prop('disabled', true).prop('title', 'Only relevant if rotated orientation is selected.');
    } else {
        $('.marginsTopBottom').prop('disabled', true).prop('title', 'Only relevant if standard orientation is selected.');
        $('.marginsLeftRight').prop('disabled', false).removeAttr('title');
    }

    if ($('#labelSize option:selected').val().includes('red')) {
        $('#print_color_black').removeClass('disabled');
        $('#print_color_red').removeClass('disabled');
    } else {
        $('#print_color_black').addClass('disabled').prop('active', true);
        $('#print_color_red').addClass('disabled');
    }

    $.ajax({
        type:        'POST',
        url:         '/api/preview/text?return_format=base64',
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
        data:        formData(),
        success: function( data ) {
            $('#previewImg').attr('src', 'data:image/png;base64,' + data);
            var img = $('#previewImg')[0];
            img.onload = function() {
                $('#labelWidth').html( (img.naturalWidth /300*2.54).toFixed(1));
                $('#labelHeight').html((img.naturalHeight/300*2.54).toFixed(1));
            };
        }
    });
}

function setStatus(data) {
    if (data['success']) {
        $('#statusPanel').html('<div id="statusBox" class="alert alert-success" role="alert"><i class="fas fa-check"></i><span>Printing was successful.</span></div>');
    } else {
        $('#statusPanel').html('<div id="statusBox" class="alert alert-warning" role="alert"><i class="fas fa-exclamation-triangle"></i><span>Printing was unsuccessful:<br />'+data['message']+'</span></div>');
    }
    $('#printButton').prop('disabled', false);
}

function print(cut_once = false) {
    $('#printButton').prop('disabled', true);
    $('#statusPanel').html('<div id="statusBox" class="alert alert-info" role="alert"><i class="fas fa-hourglass-half"></i><span>Processing print request...</span></div>');
    $.ajax({
        type:     'POST',
        dataType: 'json',
        data:     formData(cut_once),
        url:      '/api/print/text',
        success:  setStatus,
        error:    setStatus
    });
}

preview()

{% endblock %}